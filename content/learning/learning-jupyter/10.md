---
title: "十项至简规则：用Jupyter Notebook做可复现性研究"
date: 2019-08-16T09:07:57+08:00
type: docs
toc: true
weight: 10
menu:
    learning-jupyter:
        parent: 项目规划
---

Jupyter Notebook 是一个非常常用的代码编辑器，它非常适合做数据分析与代码展示，很多云服务也采用它作为代码编辑器。此外，因为用这种编辑器看代码比较轻松，文档描述和输出效果也能进一步帮助理解，很多研究者都会采用 Jupyter 作为解释研究实现的工具。

如果 Jupyter Notebook 写的好，那么研究实现及复现就更优美，如果再放到 Colab 等具有免费算力的工具上，那就比较完美了。
<!--more-->

### 声明：

- 个人笔记，乐于分享。
- 这篇文章是摘录自各公众平台上关于Jupyter Notebook的一些规则的相关文章的总结，这里只陈述的个人认为比较实用的部分。
- 如有版权问题，敬请告知。
- 参考文献：https://arxiv.org/pdf/1810.08055.pdf

## Jupyter Notebook与研究的可复现性

可复现性需要提供研究所用数据、软件、依赖项和计算环境的人类可读和机器可读的描述，以及介绍如何组合上所有部分的文档。 


之前分析人员通常将这些信息保存在单独的数据、分析、结果、配置和注释文件中（这些文件通常很难组合和共享），不过他们越来越多的使用计算型Notebook(如：Jupyter Notebooks和R Notebbooks)，在单个交互和可移植文档中组合可执行代码、渲染可视化效果和描述性文本。  

Jupyter Notebooks 大大降低了可复现性的困难，它使科学家能够轻松地编写混合了代码、结果和文本的纷纷向计算叙述，从而支持可复现性研究。  

考虑到在Jupyter Notebooks上发布可复现研究的技术和社会障碍，来自加州大学圣地亚哥分校和伯克利分销的研究者编制了一套规则、提示、工具和示例Notebook。这套规则专注于Jupyter Notebooks，不过也适用于其他混合了实时代码和叙述性描述的文档。（感谢这些人，让我等小白有迹可循快速成长）

下面是一张简单的流程图，这个我很稀罕，可以帮助我们梳理我们的工作。
![](./img/workflow.png)


个人认为其中比较重要的有**规则 3、4、5、6、7、9**

## 规则 1： 为观众讲故事

使用Jupyter Notebooks的一个好处是，它能将解释性文本与代码和结果组织在一起，创建计算型叙述.不要只保留零星的笔记，而是用解释性文字讲述一个引人入胜的故事，故事的开头介绍主题，中间介绍步骤，结尾解释结果。不仅描述你做了什么，还要描述为什么要这么做、这些步骤是如何连接的，以及他们意味着什么。

如何讲述这个故事取决于你的观众。

## 规则 2： 记录过程，而不仅仅是结果  

计算型 Notebook 的交互特性使得尝试和对比不同方法或参数更加快速和容易，以至于我们在执行这些交互调研时往往无法将其记录下来。因此，这个建议变得更加重要：确保记录下所有的探索，甚至哪些导致进入死胡同的探索！这些将帮助你记住做了什么和为什么做。

许多Notebook用户等到分析结束、得到了可靠地结果后，才添加这样的解释性文字。不要等，到那时你可能已经忘记了为什么选择某个特定的参数值、从哪里复制了一段代码，或者中间结果的有趣之处是什么。如果你没有时间全面记录你此刻正在做什么或者在想什么，留下简短的描述性笔记来提醒自己，在可以停下时抓紧把这些内容添加上。

## 规则 3： 添加分割，使步骤更清晰

Notebook 是一个交互式的环境，所以它很容易编写和运行单行单元格。这有利于实验，但会让Notebook凌乱不堪，充满难以理解的短小片段。那么，尝试让Notebook中的每一个单元格执行一个有意义的分析步骤，并且该步骤可以根据单元格中的代码或周围的markdown描述很容易地理解。

**这段比较重要**

- 按单元格模块化代码，并在单元格上方用markdown标记。
- 避免单元格太长。
- 在代码注释中放入低级文档。
- 使用描述性的markdown header 将Notebook分区，使其可以轻松导航添加目录。
- 将长Notebook分割为一系列Notebook，并保留一个top-level index Notebook，其中包含指向各个Notebook的连接。

## 规则 4：模块化代码

避免重复代码总是很好的做法，但是在Notebook中复制一个单元格、调整几行、将生成的代码粘贴到新的单元格或其他Notebook中并再次运行是特别容易的。这种试验形式很方便，但如果你想更改复制的代码的功能或修复其中的bug，就会使Notebook难以阅读，并且几乎不可能进行维护。

- **因此你可以将要复制和重用的代码包装在一个函数中**，这样就可以根据需要从任意多个单元格中调用该函数。
- 如果你要在其他项目或者Notebook中重用代码，请考虑将其转换为模块、包或库，并遵循良好的软件开发实践。
  
模块化不仅节省空间，支持维护，调式方便，还使增加交互性变的更加简单。

## 规则 5： 记录依赖项

未来重新生成分析时，不仅需要访问代码，还需要访问依赖项。

- 计算科学的最佳实践是，从一开始就是用诸如 conda 的**environment.yml**或者pip的**requirements.txt**之类的工具明确地管理依赖项，以列出所有相关的依赖项（包括他们软件的版本）。始终在这些依赖项创建的环境中工作，以确保不添加未记录的依赖项。

- 在Notebook中，你可以使用Notebook的扩展（如**watermark**）显示打印依赖项。列出Notebook中关键依赖项的版本（最好列在最下方），如果Notebook与环境隔离使用，name这将保证Notebook中仍然包含关键信息，从而帮助读者复制结果。

## 规则 6： 使用版本控制

版本控制是Notebook使用的一个重要辅助工具因为Notebook的交互特性使其很容易意外地更改或者删除重要内容。此外，由于Notebook中包含代码，代码不可避免会有bug，因此确定bug引入与修复的时间（极可能影响分析）是科学计算中的一项关键能力。

但是，请注意，Jupyter Notebook 将每个单元的代码和特定且广泛的元数据存储为JSON格式的文本文件。版本控制系统比较这些JSON文件中的差异，而不是用户友好型Notebook GUI中的差异。

## 规则 7： 构建pipeline 

记录初步探索性研究的Notebook很少能被广泛推广，但一旦确定了某种稳定的分析方法，设计良好的Notebook就可以通过pipeline推广到其他任务重，从而使用不同的输入数据和参数很容易地重复分析。记住这一点，从一开始就设计你的Notebook，以允许将来重新调整用途。把关键变量声明（尤其是在进行新的分析时，就会改变的变量）放在Notebook的顶部，而不是埋在中间的某个地方。直接在Notebook中执行准备步骤，如数据清理，冰尽可能避免手动干预。

## 规则 8：分享和数据解释性

如果底层数据被锁定，那么访问清晰注释的Notebook对可复现性也几乎没有用处。努力是你的数据或者数据样本与Notebook一起公开。Notebook可以很容易地提供输入数据和上游处理步骤的描述，这对于解释结果至关重要。

理想情况下，你可以在Notebook中共享整个数据集。我们认识到很多数据集太大或太敏感，无法以这种方式共享。在这些情况下，考虑将大型和复杂的数据集分为多个层次，这样即使数据集太大，无法与已发布Notebook一起分享，或者受到隐私或其他访问问题的限制，也不会影响到可复现性。

## 规则 9： 允许阅读、运行和探索Notebook

如果你遵循了前面的规则，那么你的Notebook应该能够捕获整个过程并易于阅读。但是其他人如何访问、运行和探索他们呢？你可以通过很多方式支持他人重用你的Notebook。

- 首先将Notebook存储到一个具备清晰README文件的公共代码库中。
- 除了允许重用之外，你还要考虑如何利用Notebook的独特结构来支持阅读和探索。至少，将所有Notebook的静态HTML/PDF版本存储在出版物附带代码库的最终版本中。

## 规则10： 促进可复现和开放的研究

显然，仅使用计算型Notebook并不能保证亚牛的可复现。如果Notebook的便利性和交互性让你满意，那你可以采取以下行动，在实验室或者工作场所宣传其可复现性。让实验室的同事试着运行你的Notebook，然后听他们解释在什么地方出了问题。也试着运行他们的Notebook，让他们知道你是否主要了障碍。

将可复现性作为研究小组所有计算工作的关键要素，而不是在分析完成后才执行，或被期刊或者评审人员要求后才思考。

---------

相信有这样系统的流程，完全可以有效的提高我们的工作效率。

另一个项目管理方案可以参考：[Project Management 项目管理方案](/blog/project-management-项目管理方案)

